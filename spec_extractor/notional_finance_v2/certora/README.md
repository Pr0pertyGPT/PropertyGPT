# Certora Verification

To setup your environment run `./setup.sh` in the root of the repository (this will install a python virtualenv) and then you can run `certora/verify.sh`.

Contract harnesses are found in `contracts/mocks/certora`.

## Account Context

Notional stores information about an account in an AccountContext struct that tracks aggregate information about an account to improve gas efficiency. It is critical that this AccountContext struct is kept up to date on every transaction or else Notional may become blind to assets or balances that exist. The relevant contracts are:

- `internal/AccountContextHandler.sol`: manages the setting of AccountContext values
- `internal/portfolio/*.sol`: manages fCash and liquidity token assets held in user portfolios
- `internal/settlement/*.sol`: manages the settlement process for fCash and liquidity token assets
- `internal/balances/BalanceHandler.sol`: manages internal accounting for cash balances
- `internal/portfolio/TransferAssets.sol`: helper methods for transferring assets

### Spec Notes

- [PASSING] SetAccountContext.spec: tests getters and setters for account context
- [FAILING] ActiveCurrencies.spec: ensures that active currency and enable bitmap currency follow rules
  - activeCurrenciesAreNotDuplicatedAndSorted: has a logic error in the spec
  - for addAssetArray: need to use a different mode of operation for bitVectorTheory and array hashes
  - `--staging alex/mark-hash-values --settings smt_hashingScheme=plainInjectivity`
  - https://prover.certora.com/output/42394/cb97439bee119a5b9305/?anonymousKey=3b518ba1aaa0585d54d3f36b9dad79a25ef5bcd8
- [INCOMPLETE] Portfolio.spec: ensures that an account's portfolio reconciles with account context
  - TODO: need to cast integers, Jeff to meet with signed integer implemention dev.
  - TODO: need to add settlement methods into harness
  - TODO: need to add transfer methods into harness

## Asset

Notional's main feature is the creation and management of fCash assets. fCash assets are defined by a currency and maturity and have a signed notional amount. fCash assets are traded on-chain in Notional markets and have a mark to market value based on the yield curve generated by those markets. These specs cover the liquidity curve that generates fCash assets and their valuation. The relevant contracts are:

- `internal/markets/DateTime.sol`: handles date math for maturities
- `internal/markets/Market.sol`: contains core liquidity curve logic
- `internal/markets/AssetRate.sol`: handles conversion between cToken (asset cash) and underlying cash value
- `internal/valuation/AssetHandler.sol`: contains logic for valuation of a single fCash or liquidity token asset
- `internal/valuation/ExchangeRate.sol`: handles conversion between underlying token value to ETH along with haircuts and buffers
- `internal/valuation/FreeCollateral.sol`: contains logic for getting the aggregate ETH free collateral value for an account

### Spec Notes

- [CERTORA ERROR] DateTime.spec: ensures that date math is correct
  - Error: bitNumAndMaturitiesMustMatch is timing out
  - https://prover.certora.com/output/42394/b3ebe7ce40a74d42ea64/?anonymousKey=37ce0b6119338d6d50b0c3c6331a141d1adfefa4
- [CERTORA ERROR] LiquidityCurve.spec: ensures properties of the liquidity curve on a single market
  - Error: spec is failing during runs
  - ABDK is probably causing the spec to fail, maybe have a generic monotonic function that we use as a dummy
  - Need to replicate the properties of natural log and exponent, monotonic and LN is not defined < 1, exp^0 == 1, exp^(less than zero) < 1, exp^(more than zero) > 1
  - Need to look at: https://app.gitbook.com/@certora/s/certora-prover/user-manual/advanced-subjects/function-summarization/internal-function-summarization
  - https://prover.certora.com/jobStatus/42394/4dbfc1d31a1f5398fd32/?anonymousKey=bef4a6f6cff5f658e8dfb63bed9a1ecc90cb4ab1
- [INCOMPLETE] Valuation.spec: ensures that the valuation of assets is correct
  - QUESTION: cash group settings should be varied, would it be advisable to use and SLOAD hook to havoc parameters?

## Governance

Governance specs cover global settings to the protocol. Relevant contracts are:

- `external/actions/GovernanceActions.sol`: external contract where governance methods are set
- `internal/markets/CashGroup.sol`: cash group getter and setter logic
- `internal/nTokenHandler.sol`: nToken getter and setter logic

### Spec Notes

- [QUESTION] CashGroup.spec: tests getters and setters for CashGroup
  - TODO: requires being able to specify structs when calling methods
- [QUESTION] GovernanceAction.spec: tests getting and setting nToken parameters and listing currencies
  - TODO: passing arrays is not currently supported, will be soon
  - TODO: need to complete some list currency rules
- [CERTORA ERROR] GovernanceOwner.spec: tests that only the owner can call governance methods
  - TODO: enableCashGroup does not complete spec, try with iter 2
  - https://prover.certora.com/output/42394/db5cb9ca7fb49414d1c0/?anonymousKey=beb7c2e8ff899fe21822f2c93c3c45d7885624c9#onlyOwnerCanUpdateGovernaceResults

## Incentives and ERC20

Notional integrates with ERC20 and Ether tokens for deposit and withdraw. These specs ensure that Notional safely integrates with those standards. Relevant contracts:

- `internal/balances/TokenHandler.sol`
- `internal/balances/Incentives.sol`
- `internal/balances/BalanceHandler.sol`
- `external/actions/nTokenAction.sol`

### Spec Notes

- [INCOMPLETE] ExternalTransfer.spec: ensures that internal account reconciles with external ERC20 transfers
- [INCOMPLETE] nTokenERC20.spec: ensures that nToken ERC20 implementation matches ERC20 spec
  - TODO: get a generic ERC20 spec
- [INCOMPLETE] Incentives.spec: ensures that incentives issued do not exceed what is specified by governance

## nToken

Notional introduces its own native ERC20 token called an nToken. An nToken is a claim on liquidity provided to the Notional protocol as an aggregate of underlying liquidity token and fCash positions. There is one nToken per currency that is traded on Notional. These contracts cover the behavior of nTokens:

- `internal/nTokenHandler.sol`
- `external/actions/nTokenMintAction.sol`
- `external/actions/nTokenRedeemAction.sol`
- `external/actions/InitializeMarkets.sol`

### Spec Notes

- [INCOMPLETE] nTokenValuation.spec: ensures that nToken valuation matches the value of underlying cash, fCash and liquidity token assets
- [INCOMPLETE] nTokenMint.spec: ensures that minting nTokens always results in a proportional increase in the nToken valuation to the tokens minted
- [INCOMPLETE] nTokenRedeem.spec: ensures that redeeming nTokens always results in a proportional decrease in the nToken valuation
- [INCOMPLETE] RollLiquidityCurve.sec: ensures that liquidity curve shifts according to specification during initialize markets
- [INCOMPLETE] nTokenCashWithholding.spec: ensures that the nToken always withholds sufficient cash to cover negative fCash residuals after initialize markets
- [INCOMPLETE] nTokenSweepCash.spec: ensures that nToken is able to sweep cash into markets after initialize markets

## Liquidation

Liquidation is required when accounts become undercollateralized. There are four types of liquidation in Notional: local currency collateral, cross currency collateral, local currency fCash and cross currency fCash. The relevant contracts are:

- `internal/valuation/FreeCollateral.sol`
- `internal/liquidation/LiquidateCurrency.sol`
- `internal/liquidation/LiquidatefCash.sol`
- `internal/liquidation/LiquidationHelpers.sol`
- `external/actions/LiquidateCurrencyAction.sol`
- `external/actions/LiquidatefCashAction.sol`

### Spec Notes

- [INCOMPLETE] PreLiquidationFactors.spec: ensure that liquidation factors like net available and free collateral are always assigned properly prior to liquidation
  - TODO: this is probably part of the Valuation spec
- [INCOMPLETE] PostLiquidationFactors.spec: ensure that pre liquidation factors hold to certain invariants after liquidation, also ensure that pre and post liquidation cash and fCash amounts reconcile
  - see: https://github.com/notional-finance/contracts-v2/blob/certora/tests/stateful/liquidation/test_liquidation.py#L236

## User Interaction

Notional batches up user deposit, withdraw and trading actions for user experience and gas efficiency. The relevant contracts are:

- `external/actions/AccountAction.sol`
- `external/actions/BatchAction.sol`
- `external/actions/ERC1155Action.sol`
- `external/actions/TradingAction.sol`

### Spec Notes

- [INCOMPLETE] Undercollateralized.spec: accounts can only deposit cash if they are undercollateralized
- [INCOMPLETE] Authorization.spec: trading can only occur on accounts with proper authorization
- [INCOMPLETE] Context.spec: trading always results in proper updates to account context, cash balance, and portfolio
- [INCOMPLETE] NonReentrant.spec: there are no opportunities for reentrancy in trading methods
